<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PictoGroup Chat ‚Äì Modern Doodle & Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --border: #e2e8f0;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }
    #auth {
      max-width: 420px;
      margin: 120px auto;
      text-align: center;
    }
    #auth h1 { font-size: 2.25rem; margin-bottom: 16px; }
    #auth p { color: #64748b; margin-bottom: 24px; }
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 1.125rem;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: var(--primary-dark); }

    #chat {
      max-width: 720px;
      margin: 0 auto;
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      overflow: hidden;
      display: none;
    }
    #online, #myName {
      padding: 12px 20px;
      background: #f0f9ff;
      text-align: center;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }
    #messages {
      height: 55vh;
      min-height: 320px;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .msg {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.45;
      font-size: 1rem;
    }
    .msg.self {
      background: #e0f2fe;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .msg.other {
      background: #f1f5f9;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .msg strong { color: #334155; display: block; margin-bottom: 4px; font-size: 0.9rem; }
    .msg img { max-width: 100%; border-radius: 10px; margin-top: 8px; display: block; }
    #input-area {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      background: white;
    }
    #messageInput {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 1rem;
      margin-bottom: 12px;
    }
    #canvas-container {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      overflow: hidden;
      background: white;
      margin-bottom: 12px;
    }
    #drawCanvas { width: 100%; height: 220px; touch-action: none; display: block; }
    #tools {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    #tools button {
      padding: 10px 16px;
      font-size: 0.95rem;
    }
    .color-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    #status { color: #64748b; font-size: 0.9rem; text-align: center; padding: 8px; }

    @media (max-width: 500px) {
      body { padding: 12px; }
      #messages { height: 50vh; }
    }
  </style>
</head>
<body>

  <div id="auth">
    <h1>groupchat</h1>
    <p>draw & chat in one global room ‚úèÔ∏èüí¨</p>
    <button id="signInBtn">Join Anonymously</button>
  </div>

  <div id="chat">
    <div id="myName"></div>
    <div id="online">Connecting...</div>
    <div id="messages"></div>

    <div id="input-area">
      <input type="text" id="messageInput" placeholder="Type a message... or draw below" autocomplete="off" />

      <div id="canvas-container">
        <canvas id="drawCanvas"></canvas>
      </div>

      <div id="tools">
        <button id="clearBtn">Clear Canvas</button>
        <button class="color-btn" style="background:black;" data-color="black"></button>
        <button class="color-btn" style="background:red;" data-color="red"></button>
        <button class="color-btn" style="background:blue;" data-color="blue"></button>
        <button class="color-btn" style="background:linear-gradient(90deg, red, orange, yellow, green, blue, violet);" data-color="rainbow">üåà</button>
        <button id="sendBtn" style="margin-left:auto;">Send</button>
      </div>
    </div>

    <div id="status">Offline? Changes will sync when back online.</div>
  </div>

  <!-- Firebase v12.9.0 ‚Äì latest as of early 2026 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import { getDatabase, ref, push, set, onChildAdded, onValue, serverTimestamp, query, limitToLast, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    // PASTE YOUR CONFIG HERE (from Firebase Console ‚Üí Project Settings ‚Üí SDK setup)
       const firebaseConfig = {

  apiKey: "AIzaSyABYcqyz8s5gqH7NVRwKurlsU9WfnXoS7A",

  authDomain: "cloudchat-bcbad.firebaseapp.com",

  databaseURL: "https://cloudchat-bcbad-default-rtdb.firebaseio.com",

  projectId: "cloudchat-bcbad",

  storageBucket: "cloudchat-bcbad.firebasestorage.app",

  messagingSenderId: "966250985643",

  appId: "1:966250985643:web:5d4fe6b54e715388921fee"

};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const messagesRef = ref(db, 'pictoMessages');
    const presenceRef = ref(db, 'presence');

    let currentUser;
    let canvas, ctx, isDrawing = false, currentColor = 'black';

    // Join button ‚Üí anonymous sign-in + name prompt
    document.getElementById('signInBtn').onclick = async () => {
      try {
        const cred = await signInAnonymously(auth);
        const user = cred.user;

        let name = prompt("Choose a fun nickname (3+ chars):", `Guest_${user.uid.slice(0,6)}`);
        name = (name || "").trim();
        if (name.length < 3) name = `Guest_${user.uid.slice(0,6)}`;

        await updateProfile(user, { displayName: name });

        await set(ref(db, `presence/${user.uid}`), {
          name,
          online: true,
          lastActive: serverTimestamp()
        });

        alert(`Welcome, ${name}! Start doodling & chatting! üé®`);
      } catch (err) {
        console.error(err);
        alert("Join failed ‚Äì check console or try again.");
      }
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        document.getElementById('auth').style.display = 'none';
        document.getElementById('chat').style.display = 'block';

        document.getElementById('myName').innerHTML = `
          You are: <strong>${user.displayName || 'Guest'}</strong>
          <button id="changeName" style="margin-left:12px; font-size:0.9rem; padding:6px 12px;">Change Name</button>
        `;

        document.getElementById('changeName')?.addEventListener('click', async () => {
          let newName = prompt("New nickname?", user.displayName);
          newName = (newName || "").trim();
          if (newName.length >= 3) {
            await updateProfile(user, { displayName: newName });
            await set(ref(db, `presence/${user.uid}/name`), newName);
            document.querySelector('#myName strong').textContent = newName;
          }
        });

        initCanvas();
        setupPresenceAndListeners();
      } else {
        document.getElementById('chat').style.display = 'none';
        document.getElementById('auth').style.display = 'block';
      }
    });

    function setupPresenceAndListeners() {
      // Presence
      onValue(ref(db, '.info/connected'), snap => {
        if (snap.val() === true && currentUser) {
          const myRef = ref(db, `presence/${currentUser.uid}`);
          set(myRef, {
            name: currentUser.displayName || `Guest_${currentUser.uid.slice(0,6)}`,
            online: true,
            lastActive: serverTimestamp()
          });
          onDisconnect(myRef).remove();
        }
      });

      onValue(presenceRef, snap => {
        const count = Object.keys(snap.val() || {}).length;
        document.getElementById('online').textContent = 
          count > 1 ? `${count} people here right now ‚úèÔ∏è` : "Just you ‚Äì invite some friends!";
      });
    }

    function initCanvas() {
      canvas = document.getElementById('drawCanvas');
      ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = 220;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.lineWidth = 6;
      ctx.strokeStyle = currentColor;

      const draw = e => {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches?.[0]?.clientX || 0) - rect.left;
        const y = (e.clientY || e.touches?.[0]?.clientY || 0) - rect.top;
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
      };

      const start = e => { e.preventDefault(); isDrawing = true; ctx.beginPath(); draw(e); };
      const move = e => { e.preventDefault(); draw(e); };
      const stop = () => isDrawing = false;

      canvas.addEventListener('pointerdown', start);
      canvas.addEventListener('pointermove', move);
      canvas.addEventListener('pointerup', stop);
      canvas.addEventListener('pointerout', stop);

      document.querySelectorAll('.color-btn').forEach(btn => {
        btn.onclick = () => {
          currentColor = btn.dataset.color;
          ctx.strokeStyle = currentColor === 'rainbow' ? createRainbow() : currentColor;
        };
      });

      document.getElementById('clearBtn').onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

      window.addEventListener('resize', () => {
        const temp = canvas.toDataURL();
        canvas.width = canvas.offsetWidth;
        const img = new Image();
        img.src = temp;
        img.onload = () => ctx.drawImage(img, 0, 0);
      });
    }

    function createRainbow() {
      const grad = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
      grad.addColorStop(0, 'red'); grad.addColorStop(0.17, 'orange');
      grad.addColorStop(0.33, 'yellow'); grad.addColorStop(0.5, 'green');
      grad.addColorStop(0.67, 'blue'); grad.addColorStop(0.83, 'indigo'); grad.addColorStop(1, 'violet');
      return grad;
    }

    document.getElementById('sendBtn').onclick = async () => {
      const text = document.getElementById('messageInput').value.trim();
      const hasDraw = ctx.getImageData(0,0,canvas.width,canvas.height).data.some(v => v > 0);

      if (!text && !hasDraw) return;

      let image = null;
      if (hasDraw) {
        image = canvas.toDataURL('image/png', 0.92);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      const name = currentUser?.displayName || `Guest_${currentUser?.uid?.slice(0,6) || '???'}`;

      const newRef = push(messagesRef);
      await set(newRef, {
        text: text || null,
        image,
        uid: currentUser?.uid,
        name,
        createdAt: serverTimestamp()
      });

      document.getElementById('messageInput').value = '';
    };

    // Load last 150 messages
    onChildAdded(query(messagesRef, limitToLast(150)), snap => {
      const msg = snap.val();
      if (!msg) return;

      const div = document.createElement('div');
      div.className = `msg ${msg.uid === currentUser?.uid ? 'self' : 'other'}`;
      div.innerHTML = `<strong>${msg.name || 'Anon'}</strong>`;

      if (msg.text) div.innerHTML += ` ${msg.text}`;
      if (msg.image) {
        const img = document.createElement('img');
        img.src = msg.image;
        img.alt = "Doodle";
        div.appendChild(img);
      }

      document.getElementById('messages').appendChild(div);
      div.scrollIntoView({ behavior: 'smooth', block: 'end' });
    });
  </script>
</body>
</html>