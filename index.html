<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getDatabase, ref, push, set, onChildAdded, onValue, serverTimestamp, query, limitToLast, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

  // YOUR FIREBASE CONFIG HERE (paste yours)
     const firebaseConfig = {

  apiKey: "AIzaSyABYcqyz8s5gqH7NVRwKurlsU9WfnXoS7A",

  authDomain: "cloudchat-bcbad.firebaseapp.com",

  databaseURL: "https://cloudchat-bcbad-default-rtdb.firebaseio.com",

  projectId: "cloudchat-bcbad",

  storageBucket: "cloudchat-bcbad.firebasestorage.app",

  messagingSenderId: "966250985643",

  appId: "1:966250985643:web:5d4fe6b54e715388921fee"

};
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const messagesRef = ref(db, 'pictoMessages');
  const presenceRef = ref(db, 'presence');

  let currentUser;

  // Auth flow with name prompt
  document.getElementById('signInBtn').onclick = async () => {
    try {
      const cred = await signInAnonymously(auth);
      const user = cred.user;

      // Prompt for name right after anonymous sign-in
      let name = prompt("Pick a fun nickname for the chat! (3+ chars)", `Guest_${user.uid.slice(0,6)}`);
      name = (name || "").trim();

      if (name.length < 3) {
        name = `Guest_${user.uid.slice(0,6)}`; // fallback
      }

      // Save to Firebase Auth profile (works for anonymous!)
      await updateProfile(user, { displayName: name });

      // Also save to presence for online list
      await set(ref(db, `presence/${user.uid}`), {
        name: name,
        online: true,
        lastSeen: serverTimestamp()
      });

      alert(`Welcome, ${name}! ðŸŽ‰`);
    } catch (error) {
      console.error("Sign-in failed:", error);
      alert("Oops, something went wrong. Try again!");
    }
  };

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      document.getElementById('auth').style.display = 'none';
      document.getElementById('chat').style.display = 'block';

      // Show current name in online area or add a header
      const nameDisplay = document.createElement('div');
      nameDisplay.id = 'myName';
      nameDisplay.style.padding = '10px';
      nameDisplay.style.background = '#e3f2fd';
      nameDisplay.style.textAlign = 'center';
      nameDisplay.innerHTML = `You are: <strong>${user.displayName || 'Mystery Guest'}</strong> 
        <button id="changeNameBtn" style="margin-left:10px; font-size:12px;">Change Name</button>`;
      document.getElementById('online').before(nameDisplay);

      // Optional: Change name button
      document.getElementById('changeNameBtn')?.addEventListener('click', async () => {
        let newName = prompt("New nickname?", user.displayName || "");
        newName = (newName || "").trim();
        if (newName.length >= 3) {
          await updateProfile(user, { displayName: newName });
          await set(ref(db, `presence/${user.uid}/name`), newName);
          document.querySelector('#myName strong').textContent = newName;
        }
      });

      initCanvas();
      setupPresence();
    } else {
      document.getElementById('chat').style.display = 'none';
      document.getElementById('auth').style.display = 'block';
      // Clean up any extra elements if needed
      document.getElementById('myName')?.remove();
    }
  });

  // Presence / online count (now shows names too if you want to expand later)
  function setupPresence() {
    onValue(ref(db, '.info/connected'), snap => {
      if (snap.val() === true && currentUser) {
        const myRef = ref(db, `presence/${currentUser.uid}`);
        set(myRef, {
          name: currentUser.displayName || `Guest_${currentUser.uid.slice(0,6)}`,
          online: true,
          lastSeen: serverTimestamp()
        });

        // Auto-remove on disconnect
        onDisconnect(myRef).remove();
      }
    });

    onValue(presenceRef, snap => {
      const users = snap.val() || {};
      const count = Object.keys(users).length;
      let text = count > 1 ? `${count} people doodling! âœï¸` : "Just you for now... invite friends!";
      
      // Optional: show list of names (uncomment if you want)
      // const names = Object.values(users).map(u => u.name || 'Anon').join(', ');
      // text += ` (${names})`;

      document.getElementById('online').textContent = text;
    });
  }

  // Canvas setup (unchanged from before, just keeping it here for completeness)
  let canvas, ctx, drawing = false, color = 'black';

  function initCanvas() {
    canvas = document.getElementById('drawCanvas');
    ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = 180;
    ctx.lineCap = 'round';
    ctx.lineWidth = 6;
    ctx.strokeStyle = color;

    const draw = e => {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
      const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    };

    ['mousedown', 'touchstart'].forEach(ev => canvas.addEventListener(ev, e => { 
      drawing = true; 
      ctx.beginPath(); 
      draw(e); 
    }, { passive: false }));

    ['mousemove', 'touchmove'].forEach(ev => canvas.addEventListener(ev, draw, { passive: false }));

    ['mouseup', 'mouseout', 'touchend', 'touchcancel'].forEach(ev => 
      canvas.addEventListener(ev, () => drawing = false));

    document.querySelectorAll('#tools button[data-color]').forEach(btn => {
      btn.onclick = () => {
        color = btn.dataset.color;
        ctx.strokeStyle = color === 'rainbow' ? createRainbowGradient() : color;
      };
    });

    document.getElementById('clearBtn').onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function createRainbowGradient() {
    const grad = ctx.createLinearGradient(0, 0, canvas.width, 0);
    grad.addColorStop(0, 'red'); grad.addColorStop(0.2, 'orange');
    grad.addColorStop(0.4, 'yellow'); grad.addColorStop(0.6, 'green');
    grad.addColorStop(0.8, 'blue'); grad.addColorStop(1, 'violet');
    return grad;
  }

  // Send message (updated to use displayName)
  document.getElementById('sendBtn').onclick = async () => {
    const text = document.getElementById('messageInput').value.trim();
    const hasDrawing = ctx.getImageData(0,0,canvas.width,canvas.height).data.some(v => v !== 0);

    if (!text && !hasDrawing) return;

    let imageData = null;
    if (hasDrawing) {
      imageData = canvas.toDataURL('image/png');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    const nameToUse = currentUser.displayName || `Guest_${currentUser.uid.slice(0,6)}`;

    const newMsgRef = push(messagesRef);
    await set(newMsgRef, {
      text: text || null,
      image: imageData,
      uid: currentUser.uid,
      name: nameToUse,
      createdAt: serverTimestamp()
    });

    document.getElementById('messageInput').value = '';
  };

  // Display messages
  onChildAdded(query(messagesRef, limitToLast(100)), snapshot => {
    const msg = snapshot.val();
    const div = document.createElement('div');
    div.className = `msg ${msg.uid === currentUser?.uid ? 'self' : 'other'}`;
    
    const nameSpan = document.createElement('strong');
    nameSpan.textContent = (msg.name || 'Anon') + ': ';
    div.appendChild(nameSpan);
    
    if (msg.text) div.appendChild(document.createTextNode(msg.text));
    if (msg.image) {
      const img = document.createElement('img');
      img.src = msg.image;
      img.alt = "Drawn pic";
      div.appendChild(img);
    }
    
    document.getElementById('messages').appendChild(div);
    div.scrollIntoView({ behavior: 'smooth' });
  });
</script>